import requests_cache
import requests
from flask import Flask
import logging

app = Flask(__name__)
log = logging.getLogger('werkzeug')
log.disabled = True

@app.route('/stories')
def index():
    logging.basicConfig(level=logging.INFO, filename="logs/logfile", filemode="a+",
                        format="%(asctime)-15s %(levelname)-8s %(message)s")
    session = requests_cache.CachedSession()
    try:
        top_comments = session.get("https://hacker-news.firebaseio.com/v0/topstories.json").json()
    except (requests.exceptions.HTTPError, requests.exceptions.ConnectionError) as err:
        print(err)
    # top_comments =[30205605333, 30203581, 30206054, 30205232, 30190397, 30205781, 30206069, 30205775, 30205709, 30188043, 30201969, 30178781, 30204565, 30204632, 30205472, 30205635, 30186091, 30204862, 30203019, 30190338, 30190254, 30186703, 30193997, 30205190, 30203429, 30176778, 30203568, 30201370, 30171712, 30200134, 30195191, 30186326, 30175581, 30196371, 30198239, 30193450, 30206342, 30205838, 30198730, 30206046, 30184457, 30200644, 30205837, 30192209, 30191669, 30195931, 30194440, 30195167, 30176448, 30193469, 30200923, 30198214, 30164501, 30199570, 30181710, 30204355, 30202714, 30191092, 30193899, 30167391, 30200339, 30191282, 30161756, 30194448, 30193521, 30190436, 30163104, 30205075, 30190004, 30190875, 30195009, 30191742, 30194345, 30203670, 30204755, 30173965, 30202913, 30192743, 30203232, 30186894, 30191412, 30179549, 30205723, 30202190, 30162726, 30205660, 30200626, 30170526, 30205328, 30204604, 30198883, 30181291, 30192558, 30199194, 30175077, 30166318, 30167750, 30191126, 30192820, 30195462, 30203192, 30205166, 30192773, 30205444, 30189822, 30196343, 30200052, 30182565, 30193236, 30183794, 30200579, 30169656, 30186708, 30181696, 30204619, 30181263, 30198804, 30202533, 30166357, 30201894, 30198626, 30195986, 30203039, 30181676, 30203796, 30191729, 30181167, 30194010, 30167037, 30200119, 30194072, 30174763, 30193473, 30191793, 30191494, 30192124, 30182767, 30187633, 30202965, 30199426, 30181560, 30177362, 30202058, 30193995, 30172163, 30190216, 30206275, 30183745, 30175344, 30202849, 30195024, 30183465, 30185229, 30202794, 30163676, 30165564, 30162678, 30182141, 30201680, 30184206, 30184792, 30181386, 30202551, 30178655, 30166108, 30182146, 30198699, 30193431, 30194868, 30181636, 30191681, 30179398, 30164420, 30203668, 30200056, 30182035, 30179355, 30176745, 30204749, 30194081, 30200820, 30162709, 30204736, 30187526, 30161626, 30203413, 30181452, 30184408, 30182251, 30204873, 30164317, 30180330, 30198884, 30185591, 30176712, 30178307, 30182692, 30179702, 30177105, 30198762, 30203087, 30198351, 30204492, 30166488, 30193256, 30180566, 30187337, 30171800, 30187793, 30193084, 30204392, 30199642, 30203203, 30184938, 30203187, 30174112, 30167403, 30201195, 30198059, 30199445, 30172647, 30192093, 30190837, 30186442, 30201677, 30194136, 30202978, 30202384, 30172268, 30167436, 30197286, 30192121, 30193276, 30200563, 30196826, 30167605, 30191854, 30177901, 30169341, 30185599, 30175956, 30186688, 30170924, 30204036, 30161837, 30204022, 30200261, 30180839, 30203058, 30167563, 30167865, 30199996, 30199995, 30200528, 30185214, 30184796, 30162767, 30202925, 30187459, 30198759, 30178764, 30184452, 30202857, 30202381, 30203302, 30201367, 30175863, 30195978, 30196496, 30176283, 30193091, 30193581, 30168241, 30199106, 30164271, 30169472, 30200614, 30198652, 30174827, 30195118, 30201091, 30192727, 30198414, 30185160, 30177033, 30180399, 30172467, 30204935, 30172641, 30181349, 30197815, 30193782, 30173375, 30179533, 30178168, 30194476, 30174518, 30197188, 30173559, 30179654, 30191161, 30162963, 30196944, 30202097, 30196765, 30162289, 30161911, 30180861, 30163068, 30165713, 30196506, 30191655, 30192269, 30195529, 30169263, 30169750, 30169714, 30162729, 30166448, 30181662, 30194636, 30203144, 30190248, 30185484, 30195444, 30178406, 30179611, 30193780, 30198558, 30166198, 30164269, 30199435, 30184104, 30192613, 30191153, 30188222, 30199186, 30202903, 30198103, 30191700, 30181312, 30201250, 30198636, 30183111, 30163983, 30188046, 30184954, 30201724, 30193804, 30201716, 30163308, 30188893, 30201661, 30163168, 30196980, 30191017, 30178571, 30186692, 30194281, 30190086, 30198654, 30202493, 30186110, 30166953, 30184454, 30172033, 30200593, 30191744, 30202380, 30168064, 30204796, 30184916, 30187234, 30191570, 30166395, 30191567, 30202223, 30189935, 30177907, 30191329, 30191288, 30200973, 30199614, 30199414, 30193375, 30190982, 30165706, 30183239, 30199137, 30202001, 30190726, 30161967, 30198847, 30181689, 30162233, 30199193, 30188161, 30188137, 30183435, 30192204, 30200150, 30181028, 30200096, 30198261, 30171986, 30180555, 30199988, 30191212, 30192687, 30173937, 30183638, 30199695, 30183533, 30167917, 30192374, 30195464, 30162509, 30199513, 30197470, 30183117, 30189664, 30189609, 30193362, 30166077, 30189527, 30201139, 30194818, 30168663, 30197851, 30186223, 30181752, 30161853, 30186545, 30173075, 30196507, 30184853, 30197413, 30200848, 30165186, 30166046, 30198440, 30179894, 30197960, 30182466, 30168044, 30165724, 30188814, 30161788, 30198099, 30188674, 30169296, 30198010, 30173844, 30179163, 30195174, 30195128, 30178361, 30200337, 30192032, 30198082, 30167969, 30162110, 30197576, 30183255, 30200155, 30183129, 30188024, 30200058, 30197293, 30178076, 30173246, 30182291, 30194246, 30170370, 30196952, 30187424, 30176141, 30202251, 30172241, 30168960, 30180651, 30175850, 30202899, 30167331, 30191081, 30195798, 30177256, 30198985, 30163141, 30182570, 30170608, 30191348, 30192863, 30185142, 30185816, 30173566, 30180967, 30198620, 30167791, 30198547]

    stories = []
    # stories = [{'author': 'todsacerdoti', 'karma': 64152, 'comments': 146, 'title': 'Go performance from version 1.2 to 1.18', 'position': 0}, {'author': 'doener', 'karma': 38703, 'comments': 6, 'title': 'Burroughs B 5500 Infomration Processing System, 1964 [pdf]', 'position': 0}, {'author': 'zdw', 'karma': 67646, 'comments': 140, 'title': 'Non-Consensual Personalization', 'position': 0}, {'author': 'bryanrasmussen', 'karma': 21756, 'comments': 48, 'title': 'How the World Went from Post-Politics to Hyper-Politics', 'position': 0}, {'author': 'CapitalistCartr', 'karma': 25048, 'comments': 11, 'title': 'What’s So Hard About Understanding Consciousness?', 'position': 0}, {'author': 'qq66', 'karma': 6182, 'comments': 48, 'title': "Ask HN: How can I make a “kid's computer” today as good as an Apple II?", 'position': 0}, {'author': 'tambourine_man', 'karma': 24514, 'comments': 61, 'title': 'Dip Switch USB Stick', 'position': 0}, {'author': 'tosh', 'karma': 101073, 'comments': 26, 'title': 'Gameboy Emulator in ARM Assembly', 'position': 0}, {'author': 'lukastyrychtr', 'karma': 4492, 'comments': 112, 'title': 'I hacked SONOS and YouTube the same day', 'position': 0}, {'author': 'kiyanwang', 'karma': 21786, 'comments': 2, 'title': 'Applying Event-Driven Architecture in Digital Transformation Projects', 'position': 0}, {'author': 'pimterry', 'karma': 5972, 'comments': 39, 'title': 'How to stop running out of ephemeral ports and love long-lived connections', 'position': 0}, {'author': 'jaytaylor', 'karma': 5945, 'comments': 4, 'title': 'Linux bcc/BPF tcplife: TCP Lifespans', 'position': 0}, {'author': 'pjmlp', 'karma': 78643, 'comments': 3, 'title': 'A Gas Dynamics Toolkit in D', 'position': 0}, {'author': 'walterbell', 'karma': 57663, 'comments': 102, 'title': 'Apple will charge 27% commission for alternative payment systems in Netherlands', 'position': 0}, {'author': 'gumby', 'karma': 34923, 'comments': 340, 'title': 'Silenced AirTags with disabled speakers are popping up for sale online', 'position': 0}, {'author': 'prostoalex', 'karma': 111688, 'comments': 1283, 'title': 'Facebook loses users for the first time', 'position': 0}, {'author': 'homarp', 'karma': 11335, 'comments': 191, 'title': 'DarkPattern.games: Find Healthy Mobile Games', 'position': 0}, {'author': 'zdw', 'karma': 67647, 'comments': 146, 'title': 'Why Not ZFS (2021)', 'position': 0}, {'author': 'ushakov', 'karma': 3002, 'comments': 249, 'title': 'Wormhole confirms all $320M in funds have been restored', 'position': 0}, {'author': 'pseudolus', 'karma': 112161, 'comments': 88, 'title': 'Last-resort cancer therapy holds back disease for more than a decade', 'position': 0}, {'author': 'throwaway888abc', 'karma': 4452, 'comments': 33, 'title': 'Australian mining billionaire files lawsuit against Facebook over scam ads', 'position': 0}, {'author': 'bookofjoe', 'karma': 36893, 'comments': 634, 'title': 'What the Omicron wave is revealing about human immunity', 'position': 0}, {'author': 'ushakov', 'karma': 3002, 'comments': 471, 'title': 'Why are semi trucks in the US and Europe so different? (2018)', 'position': 0}, {'author': 'feross', 'karma': 31169, 'comments': 12, 'title': 'Universal Basic Cop-Out', 'position': 0}, {'author': 'tectonic', 'karma': 6668, 'comments': 2, 'title': 'Browser Shell: A Linux VM in the browser serving a website', 'position': 0}, {'author': 'Tomte', 'karma': 95645, 'comments': 3, 'title': 'Fireside Friday', 'position': 0}, {'author': 'snewman', 'karma': 3140, 'comments': 313, 'title': 'How should net metering affect your electric bill?', 'position': 0}, {'author': 'benhoyt', 'karma': 4740, 'comments': 23, 'title': 'Optimizing GoAWK with a bytecode compiler and virtual machine', 'position': 0}, {'author': 'Vinnl', 'karma': 14633, 'comments': 65, 'title': 'Wolvic, a new browser project picking up where Firefox Reality leaves off', 'position': 0}, {'author': 'shawabawa3', 'karma': 4002, 'comments': 189, 'title': 'Is it safe to use __secret_internals_do_not_use_or_you_will_be_fired?', 'position': 0}, {'author': 'bryanrasmussen', 'karma': 21756, 'comments': 6, 'title': 'Design and Prototypical Implementation of an IRC Chat Server in Erlang OTP', 'position': 0}, {'author': 'simonebrunozzi', 'karma': 20753, 'comments': 0, 'title': 'Venetian glass seduced American artists a century ago', 'position': 0}, {'author': 'caaqil', 'karma': 3392, 'comments': 136, 'title': 'iPhone flaw exploited by second Israeli spy firm', 'position': 0}, {'author': 'BerislavLopac', 'karma': 20300, 'comments': 25, 'title': 'Software correctness is a lot like flossing (2020)', 'position': 0}, {'author': 'GordonS', 'karma': 17834, 'comments': 1, 'title': 'Astronomers Find First-Ever Rogue Black Hole Adrift in the Milky Way', 'position': 0}, {'author': 'GordonS', 'karma': 17834, 'comments': 0, 'title': 'New catalysts steer hydrogen fuel cells into mainstream', 'position': 0}, {'author': 'CharlesW', 'karma': 8373, 'comments': 591, 'title': 'In second largest DeFi hack, Blockchain Bridge loses $320M Ether', 'position': 0}, {'author': 'kgwgk', 'karma': 10878, 'comments': 111, 'title': 'Amazon.com announces fourth quarter results [pdf]', 'position': 0}, {'author': 'Tomte', 'karma': 95645, 'comments': 2, 'title': 'The Notorious Board Game That Takes 1,500 Hours to Complete (2018)', 'position': 0}, {'author': 'todsacerdoti', 'karma': 64152, 'comments': 1, 'title': 'Slackware Release Announcement', 'position': 0}, {'author': 'capableweb', 'karma': 15816, 'comments': 0, 'title': 'The first day of HN frontpage', 'position': 0}, {'author': 'twapi', 'karma': 7648, 'comments': 12, 'title': 'Google Workspace Essentials Starter', 'position': 0}, {'author': 'ksec', 'karma': 24259, 'comments': 105, 'title': 'Apple Podcasts suddenly became a five-star app', 'position': 0}, {'author': 'tommoor', 'karma': 3685, 'comments': 352, 'title': 'Settings are not a design failure', 'position': 0}, {'author': 'signa11', 'karma': 55109, 'comments': 0, 'title': 'Goodbye FLoC, Hello Topics', 'position': 0}, {'author': 'bryanrasmussen', 'karma': 21756, 'comments': 118, 'title': 'There Is a Much Larger Problem Than the Great Resignation', 'position': 0}, {'author': 'theafh', 'karma': 9261, 'comments': 18, 'title': 'Mathematicians Prove 30-Year-Old André-Oort Conjecture', 'position': 0}, {'author': 'maxwell', 'karma': 3638, 'comments': 3, 'title': 'futura.black', 'position': 0}, {'author': 'rbanffy', 'karma': 121827, 'comments': 0, 'title': 'Zig Programming Language', 'position': 0}, {'author': 'stared', 'karma': 8111, 'comments': 1, 'title': 'Six books that made me love science', 'position': 0}]
    counter = 0

    authors = {}

    while len(stories) < 50:
        try:
            post_url = f"https://hacker-news.firebaseio.com/v0/item/{top_comments[counter]}.json"
            response = session.get(post_url)
            logging.info(f"{post_url}  {response.elapsed}")
            comment = response.json()
            comment_author = comment['by']

            if comment_author not in authors:
                user_url = f"https://hacker-news.firebaseio.com/v0/user/{comment_author}.json"
                user_info = session.get(user_url)
                logging.info(f"{user_url}  {user_info.elapsed}")
                user = user_info.json()
                authors[user['id']] = user['karma']

            if authors[comment_author] > 2413:
                story = {
                    "author": comment_author,
                    "karma": user['karma'],
                    "comments": comment['descendants'],
                    "title": comment['title'],
                    "position": 0
                }
                stories.append(story)
            counter += 1
        except (requests.exceptions.HTTPError, requests.exceptions.ConnectionError) as err:
            print(err)

    stories.sort(key=lambda x: x['comments'], reverse=True)

    for i in range(len(stories)):
        stories[i]['position'] = i + 1

    return {"stories": stories}

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=3939)